# 8.3 클러스터 수준 트래픽/보안/리소스 관찰

### **eBPF를 이용한 쿠버네티스 클러스터 모니터링의 기본 원리**

eBPF는 커널 내부의 다양한 "훅(Hook)" 지점에 경량의 프로그램을 안전하게 로드하여 실행할 수 있도록 함. 

이 프로그램들은 패킷이 네트워크 인터페이스를 통과할 때, 시스템 호출이 발생할 때, 커널 함수가 실행될 때 등 핵심적인 이벤트가 발생할 때마다 트리거됨. 

이렇게 수집된 데이터는 eBPF 맵(Maps)이나 Perf 이벤트(Perf Events)를 통해 사용자 공간으로 전달되어, 시각화 및 분석 도구로 활용될.

쿠버네티스 클러스터에서 eBPF를 활용한 모니터링은 주로 각 노드에 DaemonSet 형태로 eBPF 에이전트를 배포하여, 해당 노드에서 발생하는 커널 이벤트를 모니터링하는 방식으로 이루어짐.

---

### **1. 트래픽 관찰 (Network Observability)**

eBPF는 쿠버네티스 클러스터 내의 네트워크 트래픽에 대한 탁월한 가시성을 제공.

- **L3/L4 트래픽 가시성**
    - **커넥션 추적:** `connect()`, `accept()`, `sendmsg()`, `recvmsg()`와 같은 소켓 관련 시스템 호출을 후킹하여 TCP/UDP 연결의 시작, 종료, 전송량, RTT(Round Trip Time) 등을 추적.
    - **패킷 흐름 분석:** 네트워크 인터페이스 드라이버 레벨(`XDP` - eXpress Data Path) 또는 트래픽 제어(`TC` - Traffic Control) 훅에 eBPF 프로그램을 부착하여, 패킷 드롭, 지연, 재전송 등 낮은 수준의 네트워크 문제를 식별할 수 있슴.
    - **IP/포트 매핑:** Pod, Service, Namespace 등 Kubernetes 리소스와 IP 주소 및 포트를 연결하여, "어떤 Pod가 어떤 Service에 연결하고 있는지", "Pod 간 트래픽이 어떤 경로로 흐르는지" 등을 명확히 파악할 수 있슴.
- **L7 (애플리케이션 계층) 트래픽 가시성:**
    - **프로토콜 파싱:** HTTP, gRPC, DNS, Kafka, Redis 등 특정 애플리케이션 프로토콜의 통신을 후킹하고 파싱하여, 요청/응답 코드, 지연 시간, API 경로, 데이터베이스 쿼리 등 애플리케이션 수준의 상세 정보를 추출할 수 있슴.
    - **서비스 맵:** 서비스 간의 의존성 및 호출 관계를 실시간으로 시각화, 복잡한 마이크로서비스 아키텍처의 트래픽 흐름을 한눈에 파악 가능.
    - **분산 트레이싱:** 특정 요청이 여러 서비스에 걸쳐 어떻게 처리되는지 추적하여, 성능 병목 지점을 정확히 찾아낼 수 있슴.
- **주요 활용 사례**
    - **성능 병목 탐지:** 특정 서비스의 네트워크 지연이나 패킷 드롭이 발생하는 원인을 규명.
    - **네트워크 문제 해결:** 잘못된 라우팅, 정책 충돌, DNS 문제 등을 식별하고 해결.
    - **네트워크 정책 유효성 검사:** 정의된 Network Policy가 예상대로 동작하는지 확인하고, 의도치 않은 통신을 찾아냄.
    - **부하 분산 최적화:** 로드 밸런서의 트래픽 분배 상태를 모니터링하고 최적화 방안을 찾음.
- **대표적인 도구**
    - **Cilium + Hubble:** Cilium CNI는 eBPF를 사용하여 네트워킹을 구현하며, Hubble은 그 위에서 네트워크 가시성을 제공. 이는 Pod 간의 모든 통신 흐름, DNS 쿼리, HTTP/gRPC 요청 등을 시각화함.
    - **Pixie (New Relic):** 애플리케이션 코드 변경 없이 eBPF를 사용하여 서비스의 상세한 트레이싱, 메트릭, 로그를 자동으로 수집.
    - **OpenTelemetry + eBPF:** OpenTelemetry Collector에 eBPF 기반 수집기를 사용하여 커널 레벨에서 메트릭, 트레이스, 로그를 수집하여 통합된 Observability 플랫폼으로 전송.

---

### **2. 보안 관찰 (Security Observability)**

eBPF는 커널 내부에서 발생하는 시스템 호출과 네트워크 이벤트를 세밀하게 모니터링함으로써, 런타임 보안 가시성과 위협 탐지 기능을 제공.

- **시스템 호출 모니터링**
    - **의심스러운 행위 탐지:** `execve`, `fork`, `openat`, `unlink`, `chmod` 등 민감한 시스템 호출을 모니터링하여, 악성 프로세스 실행, 파일 시스템 변경, 권한 상승 시도 등을 탐지함. 예를 들어, `rm -rf /` 와 같은 위험한 명령어나 `ssh` 프로세스에서 `/etc/shadow` 접근 시도 등을 감지할 수 있슴.
    - **비정상적인 프로세스 활동:** 컨테이너 내부에서 예상치 못한 프로세스가 실행되거나, 평소와 다른 방식으로 시스템 리소스에 접근하는 것을 탐지.
    - **규칙 기반 탐지:** 사전에 정의된 보안 규칙(예: `Falco` 규칙)을 eBPF 이벤트에 적용하여 특정 패턴의 위협을 자동으로 식별.
- **네트워크 기반 보안 이벤트**
    - **비정상적인 네트워크 연결:** 알려지지 않은 외부 IP로의 연결, 비표준 포트 사용, C2(Command and Control) 서버 통신 시도 등을 탐지.
    - **포트 스캐닝/브루트 포스 탐지:** 비정상적인 연결 시도 패턴을 분석하여 공격을 탐지함.
    - **DNS 쿼리 모니터링:** 악성 도메인으로의 DNS 쿼리를 탐지하여 초기 침입 징후를 파악.
- **주요 활용 사례**
    - **런타임 침입 탐지 시스템 (IDS):** 컨테이너 탈출, 랜섬웨어 활동, 루트킷 설치 시도 등 런타임 위협을 실시간으로 탐지함.
    - **보안 정책 감사:** Kubernetes NetworkPolicy나 Pod Security Standards(PSS)가 실제로 잘 적용되고 있는지, 우회 시도는 없는지 모니터링.
    - **포렌식 및 사고 대응:** 보안 사고 발생 시, eBPF가 수집한 상세한 커널 이벤트 로그를 통해 공격의 전개 과정을 재구성하고 원인을 분석함.
    - **취약점 악용 방지:** 특정 취약점을 악용하는 시스템 호출 패턴을 사전에 정의하고 탐지하여, 패치되지 않은 시스템을 보호함.
- **대표적인 도구**
    - **Falco:** eBPF를 사용하여 시스템 호출을 모니터링하고, 정의된 규칙에 따라 보안 이벤트를 탐지하고 경고함. 클라우드 네이티브 환경의 런타임 보안 표준으로 자리매김.
    - **Cilium Tetragon:** Cilium 프로젝트의 런타임 보안 및 가시성 컴포넌트. eBPF를 사용하여 시스템 호출, 프로세스 실행, 파일 접근, 네트워크 이벤트 등 저수준의 커널 이벤트를 상세하게 추적하고 감사하며, Falco와 연동하여 사용 가능.
    - **Tracee (Aqua Security):** eBPF 기반의 런타임 보안 및 포렌식 도구로, 시스템 호출 및 커널 이벤트에 대한 심층적인 가시성을 제공하고 의심스러운 동작을 탐지합니다.

---

### **3. 리소스 관찰 (Resource Observability)**

eBPF는 CPU, 메모리, 디스크 I/O 등 시스템 리소스 사용량에 대한 상세하고 효율적인 모니터링을 가능하게 함.

- **CPU 사용량 분석**
    - **콜 스택 트레이싱:** `perf_event_open`과 eBPF를 사용하여 CPU 사용량이 높은 프로세스의 콜 스택을 샘플링하여, CPU를 많이 사용하는 코드 경로를 식별.
    - **컨텍스트 스위치 모니터링:** `schedule` 관련 커널 함수를 후킹하여 불필요한 컨텍스트 스위치가 발생하는지 모니터링, 이는 성능 병목의 원인이 될 수 있슴.
    - **CPU 런큐(Run Queue) 지연:** 프로세스가 CPU를 기다리는 시간을 측정하여 시스템 부하 상태를 파악함.
- **메모리 사용량 분석**
    - **메모리 할당/해제 추적:** `kmalloc`, `kfree`, `mmap` 등 메모리 관련 시스템 호출을 후킹하여 애플리케이션의 메모리 사용 패턴을 이해하고, 메모리 누수나 비효율적인 할당을 탐지함.
    - **페이지 폴트 모니터링:** 페이지 폴트 발생 횟수를 추적하여 I/O 오버헤드를 평가.
- **디스크 I/O 모니터링**
    - **파일 시스템 접근 추적:** `read()`, `write()`, `fsync()` 등 파일 시스템 관련 시스템 호출을 후킹하여 디스크 I/O 지연, 처리량, 특정 파일의 빈번한 접근 등을 모니터링.
    - **스토리지 성능 분석:** 어떤 Pod나 프로세스가 디스크 I/O를 많이 사용하는지 파악하고, 스토리지 성능 병목을 진단.
- **주요 활용 사례**
    - **성능 튜닝 및 최적화:** 특정 워크로드의 리소스 사용 패턴을 분석하여 최적의 리소스 요청(requests) 및 제한(limits)을 설정하고, 비용 효율성을 높임.
    - **병목 지점 식별:** CPU, 메모리, I/O 중 어느 부분이 시스템의 병목 현상을 유발하는지 정확히 파악.
    - **비정상적인 리소스 사용 탐지:** 크립토마이닝과 같이 비정상적으로 높은 CPU나 메모리를 사용하는 악성 Pod를 탐지.
    - **캐싱 전략 최적화:** 파일 시스템 캐시의 효율성을 측정하고 최적화 방안을 모색.
- **대표적인 도구**
    - **`bpftrace`:** Ad-hoc 방식으로 커널의 다양한 지점을 추적하여 성능 메트릭을 수집하고 분석하는 강력한 명령줄 도구. 복잡한 리소스 사용량 패턴을 빠르게 탐색하는 데 유용함.
    - **`kubectl-trace` (Brendan Gregg의 bpftrace 기반):** Kubernetes Pod 컨텍스트에서 `bpftrace` 스크립트를 실행하여 특정 Pod의 성능 문제를 진단하는 데 사용됨.
    - **Datadog, New Relic 등 상용 솔루션:** 많은 클라우드 모니터링 벤더들이 eBPF를 사용하여 커널 레벨에서 성능 및 리소스 메트릭을 수집하고, 이를 통합된 대시보드와 경고 시스템으로 제공함

---

### **eBPF 기반 클러스터 모니터링의 장점 요약**

- **낮은 오버헤드:** 사용자 공간으로의 컨텍스트 스위치가 거의 없으며, JIT 컴파일된 코드가 커널에서 효율적으로 실행되므로 기존 방식보다 훨씬 적은 리소스를 사용.
- **깊은 가시성:** 커널 내부의 상세한 이벤트에 직접 접근하여, 기존 도구로는 얻기 어려웠던 심층적인 정보(예: 소켓 상태, 특정 시스템 호출의 인자, 커널 함수 실행 시간)를 수집할 수 있슴.
- **애플리케이션 불변성:** 애플리케이션 코드 수정이나 특별한 에이전트 주입 없이 모니터링이 가능하여, 개발자 부담을 줄이고 배포 파이프라인을 간소화함.
- **안전성:** eBPF 검증기(verifier)가 악성 코드나 시스템 충돌을 유발할 수 있는 프로그램을 차단하여 커널의 안정성을 보장.
- **유연성 및 프로그래밍 가능성:** 사용자 정의 eBPF 프로그램을 통해 특정 요구 사항에 맞는 모니터링 로직을 구현하고, 동적으로 업데이트할 수 있슴
