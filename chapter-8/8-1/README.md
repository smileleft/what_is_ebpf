# 8.1 Cilium: eBPF 기반 CNI 네트워킹

# Cilium?

cilium은 eBPF 기술을 기반으로 하는 클라우드 네이티브 네트워킹, 보안 및 가시성 솔루션.

특히 Kubernetes 환경에서 전통적인 네트워크 스택의 한계를 극복하고 고성능, 세분화된 정책 제어, 심층적인 가시성을 제공함

## Cilium과 eBPF 기반 CNI 네트워킹의 핵심

cilium이 eBPF를 사용하여 네트워킹을 구현하는 방식은 기본 CNI(Container Network Interface) 솔루션과 상이함.

1. **전통적인 CNI의 한계와 eBPF의 등장**
    - iptables 의 병목 현상 : 전통적인 CNI는 iptables 규칙을 사용하여 네트워크 정책을 적용하고 서비스 로드 밸런싱을 구현함.
    - 하지만 iptables 는 규칙 수가 많아질 수록 성능이 저하되는 O(n) 복잡성을 가지며, 규칙 업데이트 시 전체 테이블을 재로드해야 하므로 비효율적. 특히 대규모 클러스터나 동적인 마이크로 서비스 환경에서 이 문제가 심화됨.
    - **커널 수정의 어려움** : 리눅스 커널의 네트워킹 스택을 변경하려면 커널 코드를 수정하고 재컴파일해야 함. 이는 복잡한 작업이라 시스템 업그레이드를 어렵게 만듬
    - **제한된 가시성** : iptables 나 표준 리눅스 도구로는 어플리케이션 계층(L7)의 네트워크 트래픽 흐름이나 상세한 보안 이벤트에 대한 가시성을 확보하기 어려움

eBPF는 커널을 재컴파일하거나 커널 모듈을 로드하지 않고도 커널 내부의 다양한 Hook 지점에 사용자 정의 프로그램을 안전하게 삽입하여 실행할 수 있슴

이 프로그램들은 샌드박스 환경에서 실행되며, Just-In-Time 컴파일을 통해 네이티브 코드에 가까운 성능을 발휘함

1. **Cilium의 eBPF 아키넥처 핵심 원리**
    - Hook Points : Cilium은 네트워크 데이터 경로의 핵심 지점(ingress/egress, 시스템 호출, 소켓 생성 등)에 eBPF 프로그램을 부착
    - 커널 내 처리 : 패킷이 네트워크 인터페이스로 들어오거나 나갈 때, 또는 애플리케이션이 시스템 호출을 할 때, eBPF 프로그램이 직접 패킷을 검사, 필터링, 수정, 라우팅함. 이 모든 과정이 **커널 공간(kernel space)**에서 사용자 공간(user space)으로의 **컨텍스트 스위치(Context Switch) 없이** 이루어짐. 이는 `iptables`나 `kube-proxy`와 같은 사용자 공간 프록시 기반 솔루션보다 훨씬 효율적.
    - eBPF 맵(Maps) : eBPF 프로그램은 eBPF 맵을 사용하여 커널 내부에서 상태를 저장하거나, user space 어플리케이션(Cilium Agent)과 데이터를 주고 받음. 이를 톹ㅇ해 cilium Agent가 Kubernetes API 서버로부터 받은 네트워크 정책이나 서비스 엔드포인트 정보를 eBPF 프로그램에 동적으로 전달할 수 있슴
    - **JIT 컴파일:** Cilium이 생성하는 eBPF 프로그램은 커널에 로드되기 전에 JIT 컴파일러에 의해 호스트 CPU의 네이티브 명령어로 변환됩니다. 이는 최적화된 성능을 보장합니다.

1. Cilium의 주요 eBPF 기반 네트워킹 기능
    - 고성능 컨테이너 네트워킹 (L3/L4)
        - **Pod IP 할당 및 라우팅:** 각 Pod에 IP 주소를 할당하고, Pod 간의 트래픽이 효율적으로 라우팅되도록 eBPF 프로그램을 NIC 드라이버 레벨에 직접 연결. `veth` 페어나 브리지 같은 가상 네트워크 장치를 사용하지만, 트래픽 처리는 eBPF가 주도함.
        - **`iptables` 대체:** `iptables` 규칙 대신 eBPF 맵과 프로그램으로 모든 네트워크 흐름을 처리하여, `iptables`의 스케일링 문제를 해결하고 네트워크 지연 시간을 크게 줄임
        - **다이렉트 라우팅 / overlay 네트워킹:** 클러스터 환경에 따라 기본 리눅스 라우팅 테이블을 활용하는 **다이렉트 라우팅 모드**나, VXLAN/Geneve와 같은 터널링 프로토콜을 사용하는 **오버레이 모드**를 유연하게 지원. 이 또한 eBPF가 효율적으로 처리
    - 통합 서비스 로드 밸런싱 (kube-proxy 대체)
        - Cilium은 `kube-proxy`를 완전히 대체할 수 있슴. eBPF는 `connect()` 시스템 호출이나 네트워크 패킷 자체를 후킹하여 서비스 IP를 백엔드 Pod IP로 직접 변환(NAT)하고, 최적화된 로드 밸런싱 알고리즘을 커널 내부에서 실행.
        - **DSR (Direct Server Return):** Cilium은 DSR을 지원하여 응답 트래픽이 로드 밸런서를 우회하고 클라이언트로 직접 전달되도록 하여 성능을 더욱 향상시킴.
        - **XDP (eXpress Data Path) 사용:** 일부 시나리오에서는 네트워크 카드 드라이버 레벨에서 XDP eBPF 프로그램을 사용하여 패킷을 가장 낮은 계층에서 처리, 필터링 및 로드 밸런싱하여 보다 높은 성능을 달성.
    - 세분화된 네트워크 정책 (L3/L4/L7)
        - **ID 기반 보안:** Cilium은 IP 주소 대신 Kubernetes 라벨(`app=nginx`, `tier=frontend` 등)을 기반으로 워크로드에 **보안 ID**를 할당합니다. 이 ID는 eBPF 프로그램에 의해 패킷에 태그처럼 부착되어 전송됨.
        - **정책 적용:** 수신 노드의 eBPF 프로그램은 이 보안 ID를 기반으로 미리 정의된 네트워크 정책에 따라 패킷을 허용하거나 거부함. IP 주소가 동적으로 변해도 정책이 일관되게 유지됨.
        - **L7 정책:** eBPF는 소켓 레벨의 후킹을 통해 HTTP, gRPC, Kafka 등 애플리케이션 계층(L7) 프로토콜에 대한 정책 적용을 가능하게 함. 예를 들어, `GET /healthz` 요청만 허용하고 `POST /admin` 요청은 차단하는 등의 정책을 정의할 수 있슴.
    - 투명한 가시성 (Hubble)
        - Cilium은 eBPF를 사용하여 커널 내부의 모든 네트워크 흐름에 대한 상세한 메타데이터를 수집.
        - **Hubble**은 Cilium 위에 구축된 오픈 소스 가시성 플랫폼으로, 이 eBPF 데이터를 활용하여 클러스터 내의 서비스 통신을 실시간으로 시각화하고, 문제 해결 및 보안 감사를 위한 정보를 제공. 패킷 드롭, 연결 거부 등의 이벤트도 명확하게 확인 가능.
    - 투명한 암호화 (Transparent Encryption)
        - Cilium은 IPsec 또는 WireGuard를 사용하여 노드 간 트래픽을 투명하게 암호화할 수 있슴. 이 암호화/복호화 오프로드 또한 eBPF를 통해 커널에서 효율적으로 이루어지므로, 애플리케이션 변경 없이 데이터 보안을 강화할 수 있슴.

1. Cilium 구성 요소
    - **Cilium Agent:** 각 Kubernetes 노드에서 DaemonSet으로 실행. Kubernetes API 서버와 통신하여 Pod, 서비스, 네트워크 정책 등의 변경 사항을 감지하고, 이를 바탕으로 해당 노드의 커널에 eBPF 프로그램을 로드하고 관리합니다.
    - **Cilium CNI Plugin:** Kubernetes가 Pod를 스케줄링하거나 종료할 때 호출됨. Pod의 네트워크 네임스페이스를 설정하고 IP 주소를 할당하며, Cilium 에이전트에 필요한 데이터 패스 구성을 요청.
    - **Cilium Operator:** 클러스터 전체에 걸쳐 한 번만 수행되는 작업(예: IP 주소 관리, 클러스터 간 연결)을 처리.
    - **Cilium CLI (Command Line Interface):** Cilium 에이전트와 상호 작용하고 eBPF 맵을 검사하며, 클러스터 상태를 확인하는 데 사용되는 명령줄 도구.
    - **Hubble:** Cilium에서 수집한 네트워크 가시성 데이터를 제공하는 플랫폼. UI 및 CLI를 통해 상세한 네트워크 흐름을 시각화하고 분석할 수 있슴.

### 좀 더 상세한 내용은 Cilium 공식 문서를 읽어보세요.

[Welcome to Cilium’s documentation! — Cilium 1.17.5 documentation](https://docs.cilium.io/en/stable/)
