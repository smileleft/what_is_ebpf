# 2.1 eBPF란? (BPF의 역사와 확장판으로서의 의미)

BPF의 역사 : 패킷필터링

1992년 로렌스 버클리 국립 연구소(Lawrence Berkeley National Laboratory)의 **스티븐 맥캔(Steven McCanne)과 밴 제이콥슨(Van Jacobson)**은 유닉스 계열 운영체제에서 네트워크 패킷을 효율적으로 필터링하기 위한 방법을 연구하고 있었슴.

그들의 논문 "The BSD Packet Filter: A New Architecture for User-level Packet Capture"는 오늘날 **cBPF(classic BPF 또는 original BPF)**라고 불리는 기술의 기반이 됨. ([https://www.tcpdump.org/papers/bpf-usenix93.pdf](https://www.tcpdump.org/papers/bpf-usenix93.pdf))

[bpf-usenix93.pdf](2%201%20eBPF%E1%84%85%E1%85%A1%E1%86%AB%20(BPF%E1%84%8B%E1%85%B4%20%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%89%E1%85%A1%E1%84%8B%E1%85%AA%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%91%E1%85%A1%E1%86%AB%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%A5%E1%84%8B%E1%85%B4%20%E1%84%8B%E1%85%B4%E1%84%86%E1%85%B5)%202012c18e27da8037a1aac231db2aa310/bpf-usenix93.pdf)

cBPF의 주요 특징 및 목적

1. 효율적인 패킷 필터링: tcpdump와 같은 네트워크 모니터링 도구가 커널 공간에서 직접 패킷을 필터링하여 필요한 데이터만 사용자 공간으로 복사하도록 설계됨. 따라서 불필요한 데이터 복사로 인한 성능 저하를 줄이는 것이 가능해짐
2. 간단한 가상머신 : cBPF는 레지스터 기반의 간단한 가상머신에서 실행되는 바이트 코드를 사용. 이 가상머신(vm)은 커널 내에서 안전하게 동작되도록 설계됨
3. 안전성: 커널의 안정성을 해치지 않도록 커널 내에서 실행하기 전에 검증기(verifier)의 검증과정을 거침. 이 검증기는 루프(loop) 사용을 제한하고, 허용되지 않은 메모리 접근을 차단하는 등의 역할을 함
4. 제한된 기능: cBPF는 주로 패킷 필터링에 초점을 맞추었기 때문에, 명령어 세트가 단순하고 범용적인 프로그래밍에는 한계가 있었슴 → 네트워크 패킷 처리에 국한되어 사용됨

## eBPF의 등장

2010년대 초반, 리눅스 커널 개발자들이 cBPF를 확장하여 커널의 더 많은 부분에 적용할 수 있는 방법을 모색하기 시작. Alexei Starovoitov(현재 Meta에 근무)는 이 확장을 주도했으며, 2014년 리눅스 커널 3.18 버전에 eBPF(extended BPF)가 공식적으로 도입됨.([https://kernelnewbies.org/Linux_3.18](https://kernelnewbies.org/Linux_3.18))

eBPF는 cBPF의 단순 패킷 필터링 기능을 넘어서 커널의 기능을 화장할 수 있는 범용 실행 엔진으로 발전.

| 주요 내용 | 설명 |
| --- | --- |
| 현대화된 명령어 세트(ISA) | 64비트 레지스터와 더 많은 명령어를 지원, 복잡한 로직 구현이 가능하게 됨 |
| BPF Maps | 다양한 데이터구조(해시테이블, 배열)를 커널 내에 생성하고, eBPF 프로그램 간 또는 eBPF 프로그램과 사용자 공간 어플리케이션 간 데이터를 공유할 수 있는 매커니즘 제공 |
| Helper Functions | eBPF 프로그램이 호출할 수 있는 미리 정의된 커널 함수 세트.
eBPF 프로그램은 Helper Functions 를 통해 직접적인 하드웨어 접근 없이 안전하게 커널의 다양한 기능(현재 시간 가져오기, 네트워크 패킷 수정, 소켓 리다이렉션 등)을 활용할 수 있슴 |
| 다양한 부착  지점(Attachment Points) | eBPF 프로그램은 네트워크 소켓 뿐 아니라 커널 tracepoints, kprobes, ubrobes, XDP(eXpress Data Path), TC(Traffic Control) 등 커널 내부의 다양한 이벤트 지점에 부착되어 실행 가능 → 시스템 모니터링, 보안 감시 분야로 사용 범위가 확장됨 |
| JIT(Just-In-Time) 컴파일 | eBPF 바이트 코드는 커널에 로드될 때 특정 아키텍처의 네이티브 기계 코드로 컴파일되어 cBPF보다 뛰어난 성능을 제공함 |
| C언어 기반 프로그래밍 | LLVM 컴파일러 툴체인(Clang) 을 사용하여 C언어의 일부 기능으로 eBPF 프로그램을 작성하고 컴파일 할 수 있게 되어 개발 편의성이 향상됨(모든 c 언어의 기능이 지원되는 것은 아님) |

## 확장판으로서의 eBPF의 의미

eBPF는 cBPF의 단순확장 이상의 으미를 지님. 리눅스 커널을 프로그래밍 가능하게 만드는 패러다임의 전환이 됨

1. 커널의 동적 확장성 확보
    1. 과거에는 커널 기능을 수정하거나 추가하려면 커널 모듈을 작성하고 컴파일하거나, 커널 자체를 재컴파일해야 했슴. → 오랜 시간이 걸리고 위험 부담이 큼
    2. eBPF는 커널 재컴파일이나 모듈 로드 없이 안전하게 커널의 동작을 동적으로 변경하고 확장하는 방법을 제공. → 커널 위에서 작은 어플리케이션을 실행하는 것과 유사함
2. 성능과 안전성의 조화
    1. JIT 컴파일을 통해 네이티브 코드에 가까운 속도로 실행되면서도 검증기(verifier)를 통해 검증하기에 커널의 안정성을 해치지 않음.
3. 다양한 활용 분야
    1. 네트워킹: 고성능 패킷 처리, 로드 밸런싱, DDoS 방어(XDP, TC), 복잡한 네트워크 정책 적용 등
    2. 관찰가능성(Observablity) 및 트레이싱: 시스템 콜 추적, 함수 실행 시간 측정, 성능 병목 분석, 커스텀 메트릭 수집 등 시스템 내부를 깊이 있게 들여다 볼 수 있슴 → kprobes, uprobes, tracepoints, perf_events 활용
    3. 보안: 침입탐지시스템(IDS), 어플리케이션 샌드박싱, 시스템 콜 필터링, 보안 정책 강제 적용 등 다양한 보안 솔루션 구축에 활용됨
    4. 컨테이너 및 클라우드 네이티브 환경: Cilium, Falco 와 같은 프로젝트들은 eBPF를 핵심 기술로 사용하여 컨테이너 네트워킹,  보안, 모니터링 기능을 혁신하는 중
4. Javascript of Kernel
    1. 웹 브라우저에서 자바스크립트가 웹페이지의 동작을 동적으로 변경하고 확장하듯, eBPF는 리눅스 커널의 동작을 안전하고 효율적으로 프로그래밍 할 수 있게 함.
5. 혁신 가속화
    1. 개발자들은 커널의 핵심 코드를 직접 수정하지 않고도 eBPF를 통해 새로운 아이디어나 기능을 빠르게 프로토타이핑하고 배포할 수 있게 됨. 이는 커널 기능 발전과 시스템 혁신을 가속화함