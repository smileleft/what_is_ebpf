# 7.1 LSM (Linux Security Module)과 eBPF

# LSM(Linux Security Module)

LSM은 리눅스 커널에 보안정책을 적용하고 강제하는 프레임워크.

커널내부의 다양한 주요지점(hooks)에 보안 모듈을 연결하여 파일접근, 프로세스 생성, 네트워크 통신 등 시스템 호출이 발생할 때마다 보안 정책을 평가 하고 접근제어 결정을 내릴 수 있게 함

주요특징

- **강제적 접근 제어(MAC - Mandatory Access Control)** : 전통적인 DAC(Discretionary Access Control) 와 달리, LSM은 사용자나 프로세스의 권한과 관계없이 사전에 정의된 보안정책에 따라 접근을 강제함. 예를 들어 SELinux 나 AppArmor 같은 모듈은 특정 어플리케이션이 접근할 수 있는 파일이나 네트워크 포트를 엄격하게 제한할 수 있슴
- **모듈화된 아키텍처** : 커널 자체에 보안 로직을 직접 코딩하는 대신 모듈  형태로 보안정책을 구현하고 로드/언로드함. 이는 다양한 보안 모델(예: SELinux, AppArmor, SMACK) 을 유영한게 적용 가능하게 함
- **다앙한 Hook 지점** : LSM은 커널 내에 수백 개의 Hook 지점을 가지고 있어 시스템 호출의 거의 모든 단계에서 보안 검사를 수행할 수 있슴
- **주요 LSM 구현체**
    - **SELinux** (Security-Enhanced Linux) : 미국 국가안보국(NSA)이 개발한 MAC 시스템으로, 매우 세분화된 접근 제어를 제공. 타입(type), 역할(role), 사용자(user), 민감도(level) 등 복잡한 보안 컨텍스트를 기반으로 정책을 적용. 정책 작성이 복잡하지만, 강력한 보안을 제공함.
    - **AppArmor :** 애플리케이션 기반의 MAC 시스템으로, 특정 애플리케이션이 접근할 수 있는 리소스를 프로필 기반으로 제어합니다. SELinux보다 설정이 비교적 간단하여 사용하기 쉬움
    - **SMACK** (Simplified Mandatory Access Control Kernel) : 간단하고 강력한 MAC 시스템. 레이블 기반의 접근제어를 사용

동작방식

1. 초기화 : 시스템 부팅 시, 선택된 LSM 모듈이 커널에 로드되고, 해당 모듈의 보안 Hook 함수들이 커널의 Hook 지점에 등록됨
2. 시스템 호출 발생 : 사용자 애플리케이션이 파일 열기, 프로세스 실행 등 시스템 호출을 요청
3. LSM Hook 호출 : 커널은 해당 시스템 호출을 처리하기 전에, 관련 LSM Hook 함수를 호출
4. 정책 평가 : LSM 모듈의 Hook 함수는 미리 정의된 보안 정책에 따라 해당 작업의 허용 여부를 평가함. 예를 들어, SELinux는 현재 프로세스의 보안 컨텍스트와 접근하려는 객체의 보안 컨텍스트를 비교하여 접근을 허용할지 결정
5. 결정 및 처리
    1. 정책이 허용하면 → 시스템 호출이 정상적으로 진행됨
    2. 정책이 거부하면 → 시스템 호출 실패 & EPERM(Permission denied) 오류 발생

# LSM과 eBPF의 관계 및 상호 보완성

LSM과 eBPF는 리눅스 보안을 강화하는데 있어 서로 다른 강점을 가지고 있으며, 상호 보완적으로 사용할 수 있슴

- LSM의 강점
    - **강제적 접근 제어의 표준 프레임워크:** 리눅스 커널에 깊이 통합되어 있어 시스템 전반에 걸친 강력하고 일관된 보안 정책을 적용하는 데 최적화되어 있슴
    - **광범위한 적용 범위:** 파일 시스템, 프로세스, 네트워크 등 거의 모든 커널 객체와 상호작용에 대한 접근 제어를 제공
    - **성숙하고 검증된 솔루션:** SELinux와 AppArmor는 오랜 기간 동안 광범위하게 사용되며 보안 효과가 입증됨
- eBPF의 강점
    - **유연성과 동적 로딩:** 커널 재컴파일 없이 실시간으로 새로운 보안 로직을 추가하거나 변경할 수 있슴
    - **세분화된 이벤트 처리:** LSM이 커버하지 못하는 특정 커널 함수 호출, 내부 데이터 구조 접근 등 매우 세밀한 수준의 이벤트에 반응할 수 있슴
    - **성능 모니터링 및 감사에 용이:** 오버헤드가 적으면서도 풍부한 컨텍스트 정보를 수집하여 실시간 모니터링 및 포렌식에 강력한 도구
    - **프로그래밍 가능한 보안 로직:** 단순히 정책을 적용하는 것을 넘어, 복잡한 조건부 로직이나 통계 분석을 포함하는 보안 기능을 구현할 수 있슴
- 상호보완 활용 예시
    - LSM 기반 정책 강화 + eBPF 기반 모니터링
        - SELinux나 AppArmor로 기본적인 시스템의 MAC 정책을 강력하게 적용
        - 여기에 eBPF를 사용하여 해당 정책을 우회하려는 시도나, 정책 적용 범위를 벗어나는 의심스러운 행위를 실시간으로 모니터링하도록 구성. SELinux 가 허용한 파일 접근이라도 eBPF로 특정 패턴의 접근을 탐지하여 비정상적인 행위를 경고할 수 있슴
    - LSM Hook에 eBPF 프로그램 부착
        - 리눅스 커널 5.7부터는 eBPF 프로그램이 LSM Hook에 직접 부착될 수 있도록 지원됨. 즉, eBPF를 사용하여 LSM 프레임워크의 기존 정책을 보강하거나, 새로운 맞춤형 보안 정책을 동적으로 추가할 수 있슴
        - 예를 들어 `LSM_HOOK_PATH_MKNOD`와 같은 특정 LSM Hook에 eBPF 프로그램을 부착하여 특정 조건에서만 노드 생성을 허용하거나 추가적인 검사를 수행할 수 있슴.  이를 통해 기존 LSM 정책의 한계를 넘어선 매우 정교한 접근 제어가 가능
    - Zero-day 공격방어
        - 새로운 제로데이 취약점이 발견되었을 때, 커널 패치를 기다리지 않고 eBPF를 이용하여 해당 취약점을 악용하는 특정 시스템 호출 패턴을 실시간으로 탐지하고 차단하는 방어 로직을 배포할 수 있슴
        - 이와 동시에, LSM을 통해 시스템의 전반적인 공격 표면을 줄여 공격의 성공 가능성을 낮출 수 있슴
